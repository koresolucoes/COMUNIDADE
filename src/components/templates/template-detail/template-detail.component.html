<div>
  @if(!template()) {
    <p class="text-center text-gray-400">Carregando template...</p>
  } @else {
    @if(template(); as t) {
      <div class="flex flex-col lg:flex-row gap-8">
        <!-- Main Content: Workflow View -->
        <div class="flex-grow lg:w-3/4">
          <h1 class="text-3xl md:text-4xl font-bold text-white tracking-tight">{{ t.title }}</h1>
          <div class="mt-2 mb-4">
            <span class="text-sm font-medium bg-blue-accent/20 text-blue-300 px-2.5 py-1 rounded-full capitalize">{{ t.category }}</span>
          </div>
          <div class="h-[75vh] w-full bg-gray-900 border border-gray-800 rounded-lg overflow-hidden relative">
            @if(workflowData()) {
              <div #drawflowContainer id="drawflow" class="absolute inset-0 w-full h-full bg-gray-950"></div>
            } @else {
              <div class="flex items-center justify-center h-full text-center text-gray-500 p-4">
                Visualização indisponível. O JSON do workflow pode ser inválido ou não foi fornecido.
              </div>
            }
             <div class="absolute bottom-2 right-2 bg-gray-950/50 backdrop-blur-sm p-1 rounded-md text-xs text-gray-400">
              Scroll para zoom. Arraste o fundo para mover o canvas.
            </div>
          </div>
        </div>

        <!-- Sidebar: Info and Actions -->
        <div class="lg:w-1/4 flex-shrink-0">
          <div class="p-6 bg-gray-900 border border-gray-800 rounded-lg space-y-6 sticky top-8">
            <div>
              <h2 class="text-lg font-semibold text-white">Sobre este Template</h2>
              <p class="mt-2 text-sm text-gray-400">{{ t.description }}</p>
            </div>
             @if(t.author) {
              <div>
                <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Autor</h3>
                <div class="flex items-center gap-2 mt-2">
                   <div class="w-8 h-8 bg-gray-700 rounded-full flex items-center justify-center text-sm font-bold text-white uppercase flex-shrink-0 overflow-hidden">
                      @if(t.author.avatar_url; as avatarUrl) {
                          <img [src]="avatarUrl" [alt]="t.author.username || ''" class="w-full h-full object-cover">
                      } @else {
                          <span>{{ (t.author.username || '?')[0] }}</span>
                      }
                  </div>
                  <span class="font-medium text-gray-300">{{ t.author.username }}</span>
                </div>
              </div>
            }
            <div>
              <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Como Usar</h3>
              <ol class="list-decimal list-inside text-sm text-gray-400 space-y-1 mt-2">
                <li>Copie ou baixe o workflow abaixo.</li>
                <li>Na sua instância n8n, vá em "Workflows".</li>
                <li>Clique em "Import from Clipboard" ou "Import from File".</li>
                <li>Ou conecte sua instância e envie diretamente.</li>
              </ol>
            </div>

            <div class="space-y-3">
              <button (click)="copyWorkflow()" [disabled]="!workflowData()" class="w-full px-4 py-2 bg-gray-700 text-white rounded-md font-semibold hover:bg-gray-600 transition-colors flex items-center justify-center gap-2 disabled:opacity-50">
                <span class="material-icons-outlined text-base">content_copy</span>
                {{ copyJsonButtonText() }}
              </button>
              <button (click)="downloadWorkflow()" [disabled]="!workflowData()" class="w-full px-4 py-2 bg-gray-700 text-white rounded-md font-semibold hover:bg-gray-600 transition-colors flex items-center justify-center gap-2 disabled:opacity-50">
                <span class="material-icons-outlined text-base">download</span>
                Download (JSON)
              </button>
              <button 
                (click)="sendToN8n()" 
                [disabled]="!workflowData() || !n8nApiService.isConnected() || sendToN8nStatus() === 'loading'"
                class="w-full px-4 py-2 bg-blue-accent text-white rounded-md font-semibold hover:bg-blue-accent/90 transition-colors flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                [title]="!n8nApiService.isConnected() ? 'Conecte sua instância n8n no Gerenciador para usar esta função' : ''">
                @if(sendToN8nStatus() === 'loading') {
                  <span class="material-icons-outlined animate-spin text-base">sync</span>
                  <span>Enviando...</span>
                } @else {
                  <span class="material-icons-outlined text-base">send</span>
                  <span>Enviar para n8n</span>
                }
              </button>
            </div>

            @if(sendToN8nStatus() === 'success') {
              <p class="text-xs text-center text-green-accent">{{ sendToN8nMessage() }}</p>
            }
            @if(sendToN8nStatus() === 'error') {
              <p class="text-xs text-center text-red-400">{{ sendToN8nMessage() }}</p>
            }
          </div>
        </div>
      </div>

      <!-- Comments Section -->
      <div class="mt-16 pt-8 border-t border-gray-800">
        <h2 class="text-2xl font-semibold text-white mb-6">{{ comments().length }} Comentários</h2>
        <div class="space-y-6">
          @if(commentsLoading() && comments().length === 0) {
            <p class="text-gray-400">Carregando comentários...</p>
          } @else if(commentsError()) {
            <p class="text-red-400">{{ commentsError() }}</p>
          } @else {
            @for(comment of comments(); track comment.id) {
              <div class="flex gap-4">
                <div class="w-8 h-8 bg-gray-700 rounded-full flex items-center justify-center text-sm font-bold text-white uppercase flex-shrink-0 mt-1 overflow-hidden">
                   @if(comment.author?.avatar_url; as avatarUrl) {
                      <img [src]="avatarUrl" [alt]="comment.author?.username || ''" class="w-full h-full object-cover">
                  } @else {
                      <span>{{ (comment.author?.username || '?')[0] }}</span>
                  }
                </div>
                <div class="flex-1 bg-gray-900 border border-gray-800 rounded-lg p-4">
                  <div class="flex items-center justify-between text-sm mb-2">
                    <span class="font-semibold text-gray-300">{{ comment.author?.username || 'Usuário' }}</span>
                    <span class="text-gray-500">{{ comment.created_at | date:'dd/MM/yyyy HH:mm' }}</span>
                  </div>
                  <p class="text-gray-300 leading-relaxed whitespace-pre-wrap">{{ comment.content }}</p>
                </div>
              </div>
            }
          }
        </div>
      </div>
      
      <!-- New Comment Form -->
      <div class="mt-12 pt-8 border-t border-gray-800">
        @if(authService.currentUser()) {
          <h3 class="text-xl font-semibold text-white mb-4">Adicionar um comentário</h3>
          <div class="space-y-4">
            <textarea 
              [(ngModel)]="newCommentContent"
              rows="4" 
              class="w-full bg-gray-800 border-gray-700 text-white rounded-md p-2 focus:ring-blue-accent focus:border-blue-accent" 
              placeholder="Digite seu comentário...">
            </textarea>
            <button (click)="postComment()" [disabled]="commentsLoading() || !newCommentContent().trim()" class="px-6 py-2 bg-blue-accent text-white rounded-md font-semibold hover:bg-blue-accent/90 transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
              @if(commentsLoading()) {
                <span>Enviando...</span>
              } @else {
                Enviar Comentário
              }
            </button>
          </div>
        } @else {
          <div class="text-center p-6 bg-gray-900 border border-dashed border-gray-700 rounded-lg">
            <p class="text-gray-400">Você precisa estar logado para comentar.</p>
            <a routerLink="/login" class="mt-2 inline-block font-semibold text-blue-accent hover:underline">Fazer Login</a>
          </div>
        }
      </div>
    } @else {
      <div class="text-center py-16">
        <h1 class="text-3xl font-bold text-white">Template não encontrado</h1>
        <p class="mt-2 text-gray-400">O template que você está procurando não existe ou foi movido.</p>
        <a routerLink="/templates" class="mt-6 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-accent hover:bg-blue-accent/90">
            Voltar para a Galeria
        </a>
    </div>
    }
  }
</div>