<div>
  @if(!template()) {
    <p class="text-center text-gray-400">Carregando template...</p>
  } @else {
    @if(template(); as t) {
      <div class="flex flex-col lg:flex-row gap-8">
        <!-- Main Content: Workflow View -->
        <div class="flex-grow lg:w-3/4">
          <h1 class="text-3xl md:text-4xl font-bold text-white tracking-tight">{{ t.title }}</h1>
          <div class="mt-2 mb-4">
            <span class="text-sm font-medium bg-blue-accent/20 text-blue-300 px-2.5 py-1 rounded-full capitalize">{{ t.category }}</span>
          </div>
          <div class="h-[75vh] w-full bg-gray-900 border border-gray-800 rounded-lg overflow-auto relative">
            <!-- Aviso sobre a pré-visualização -->
            <div class="absolute top-2 left-2 z-20 p-2 bg-yellow-900/50 border border-yellow-700/50 text-yellow-300 rounded-lg text-xs flex items-start gap-2 max-w-sm">
              <span class="material-icons-outlined text-yellow-400 mt-0.5 text-base">info</span>
              <span>
                <strong>Aviso:</strong> Esta é uma pré-visualização gerada em HTML e serve apenas como guia visual. Para uma representação fiel e para testar, recomendamos importar e visualizar o workflow diretamente no n8n.
              </span>
            </div>
            
            @if(visualGraph(); as graph) {
              <div class="relative" [style.width.px]="graph.width" [style.height.px]="graph.height">
                <!-- SVG for Connectors -->
                <svg class="absolute top-0 left-0 w-full h-full" [attr.viewBox]="'0 0 ' + graph.width + ' ' + graph.height">
                  <defs>
                    <marker id="arrowhead" viewBox="0 0 10 10" refX="8" refY="5" markerUnits="strokeWidth" markerWidth="6" markerHeight="4" orient="auto">
                      <path d="M 0 0 L 10 5 L 0 10 z" fill="#8b949e"></path>
                    </marker>
                  </defs>
                  @for(edge of graph.edges; track edge.id) {
                    <path [attr.d]="edge.path" class="connector-path" />
                    @if(edge.label) {
                      <text [attr.x]="edge.labelX" [attr.y]="edge.labelY" class="connector-label">{{ edge.label }}</text>
                    }
                  }
                </svg>

                <!-- Nodes -->
                @for(node of graph.nodes; track node.id) {
                  @if (node.isStickyNote) {
                    <div 
                      class="absolute sticky-note z-0" 
                      [style.left.px]="node.x" 
                      [style.top.px]="node.y" 
                      [style.width.px]="node.width" 
                      [style.height.px]="node.height"
                      [class.sticky-note-color-3]="node.noteColor === 3"
                      [class.sticky-note-color-4]="node.noteColor === 4"
                      [class.sticky-note-color-5]="node.noteColor === 5"
                      [class.sticky-note-color-6]="node.noteColor === 6"
                      [class.sticky-note-color-7]="node.noteColor === 7"
                      >
                        {{ node.content }}
                    </div>
                  } @else {
                    <div class="absolute z-10" [style.left.px]="node.x" [style.top.px]="node.y" [style.width.px]="node.width" [style.height.px]="node.height">
                      <div class="n8n-node-card">
                        <div class="n8n-node-header" [style.background-color]="node.color">
                          <span class="material-icons-outlined">{{ node.icon }}</span>
                          <span class="n8n-node-type-name">{{ node.friendlyName }}</span>
                        </div>
                        <div class="n8n-node-body">
                          <span class="n8n-node-label" [title]="node.name">{{ node.name }}</span>
                          @if(node.parameters && node.parameters.length > 0) {
                            <div class="n8n-node-parameters">
                              @for(param of node.parameters; track param.key) {
                                <div class="parameter-item">
                                  <span class="parameter-key">{{ param.key }}:</span>
                                  <span class="parameter-value" [title]="param.value">{{ param.value }}</span>
                                </div>
                              }
                            </div>
                          }
                        </div>
                      </div>
                    </div>
                  }
                }
              </div>
            } @else if (workflowData()) {
              <div class="flex items-center justify-center h-full text-center text-gray-500 p-4">
                Este workflow não contém nós para visualizar.
              </div>
            } @else {
              <div class="flex items-center justify-center h-full text-center text-gray-500 p-4">
                Visualização indisponível. O JSON do workflow pode ser inválido ou não foi fornecido.
              </div>
            }
            <div class="absolute bottom-2 right-2 bg-gray-950/50 backdrop-blur-sm p-1 rounded-md text-xs text-gray-400">
              Role para ver todo o fluxo.
            </div>
          </div>
        </div>

        <!-- Sidebar: Info and Actions -->
        <div class="lg:w-1/4 flex-shrink-0">
          <div class="p-6 bg-gray-900 border border-gray-800 rounded-lg space-y-6 sticky top-8">
            <div>
              <h2 class="text-lg font-semibold text-white">Sobre este Template</h2>
              <p class="mt-2 text-sm text-gray-400">{{ t.description }}</p>
            </div>
             @if(t.author) {
              <div>
                <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Autor</h3>
                <div class="flex items-center gap-2 mt-2">
                   <div class="w-8 h-8 bg-gray-700 rounded-full flex items-center justify-center text-sm font-bold text-white uppercase flex-shrink-0 overflow-hidden">
                      @if(t.author.avatar_url; as avatarUrl) {
                          <img [src]="avatarUrl" [alt]="t.author.username || ''" class="w-full h-full object-cover">
                      } @else {
                          <span>{{ (t.author.username || '?')[0] }}</span>
                      }
                  </div>
                  <span class="font-medium text-gray-300">{{ t.author.username }}</span>
                </div>
              </div>
            }
            <div>
              <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Como Usar</h3>
              <ol class="list-decimal list-inside text-sm text-gray-400 space-y-1 mt-2">
                <li>Copie ou baixe o workflow abaixo.</li>
                <li>Na sua instância n8n, vá em "Workflows".</li>
                <li>Clique em "Import from Clipboard" ou "Import from File".</li>
                <li>Ou conecte sua instância e envie diretamente.</li>
              </ol>
            </div>

            <div class="space-y-3">
              <button (click)="copyWorkflow()" [disabled]="!workflowData()" class="w-full px-4 py-2 bg-gray-700 text-white rounded-md font-semibold hover:bg-gray-600 transition-colors flex items-center justify-center gap-2 disabled:opacity-50">
                <span class="material-icons-outlined text-base">content_copy</span>
                {{ copyJsonButtonText() }}
              </button>
              <button (click)="downloadWorkflow()" [disabled]="!workflowData()" class="w-full px-4 py-2 bg-gray-700 text-white rounded-md font-semibold hover:bg-gray-600 transition-colors flex items-center justify-center gap-2 disabled:opacity-50">
                <span class="material-icons-outlined text-base">download</span>
                Download (JSON)
              </button>
              <button 
                (click)="sendToN8n()" 
                [disabled]="!workflowData() || !n8nApiService.isConnected() || sendToN8nStatus() === 'loading'"
                class="w-full px-4 py-2 bg-blue-accent text-white rounded-md font-semibold hover:bg-blue-accent/90 transition-colors flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                [title]="!n8nApiService.isConnected() ? 'Conecte sua instância n8n no Gerenciador para usar esta função' : ''">
                @if(sendToN8nStatus() === 'loading') {
                  <span class="material-icons-outlined animate-spin text-base">sync</span>
                  <span>Enviando...</span>
                } @else {
                  <span class="material-icons-outlined text-base">send</span>
                  <span>Enviar para n8n</span>
                }
              </button>
            </div>

            @if(sendToN8nStatus() === 'success') {
              <p class="text-xs text-center text-green-accent">{{ sendToN8nMessage() }}</p>
            }
            @if(sendToN8nStatus() === 'error') {
              <p class="text-xs text-center text-red-400">{{ sendToN8nMessage() }}</p>
            }
          </div>
        </div>
      </div>

      <!-- Comments Section -->
      <div class="mt-16 pt-8 border-t border-gray-800">
        <h2 class="text-2xl font-semibold text-white mb-6">{{ comments().length }} Comentários</h2>
        <div class="space-y-6">
          @if(commentsLoading() && comments().length === 0) {
            <p class="text-gray-400">Carregando comentários...</p>
          } @else if(commentsError()) {
            <p class="text-red-400">{{ commentsError() }}</p>
          } @else {
            @for(comment of comments(); track comment.id) {
              <div class="flex gap-4">
                <div class="w-8 h-8 bg-gray-700 rounded-full flex items-center justify-center text-sm font-bold text-white uppercase flex-shrink-0 mt-1 overflow-hidden">
                   @if(comment.author?.avatar_url; as avatarUrl) {
                      <img [src]="avatarUrl" [alt]="comment.author?.username || ''" class="w-full h-full object-cover">
                  } @else {
                      <span>{{ (comment.author?.username || '?')[0] }}</span>
                  }
                </div>
                <div class="flex-1 bg-gray-900 border border-gray-800 rounded-lg p-4">
                  <div class="flex items-center justify-between text-sm mb-2">
                    <span class="font-semibold text-gray-300">{{ comment.author?.username || 'Usuário' }}</span>
                    <span class="text-gray-500">{{ comment.created_at | date:'dd/MM/yyyy HH:mm' }}</span>
                  </div>
                  <p class="text-gray-300 leading-relaxed whitespace-pre-wrap">{{ comment.content }}</p>
                </div>
              </div>
            }
          }
        </div>
      </div>
      
      <!-- New Comment Form -->
      <div class="mt-12 pt-8 border-t border-gray-800">
        @if(authService.currentUser()) {
          <h3 class="text-xl font-semibold text-white mb-4">Adicionar um comentário</h3>
          <div class="space-y-4">
            <textarea 
              [(ngModel)]="newCommentContent"
              rows="4" 
              class="w-full bg-gray-800 border-gray-700 text-white rounded-md p-2 focus:ring-blue-accent focus:border-blue-accent" 
              placeholder="Digite seu comentário...">
            </textarea>
            <button (click)="postComment()" [disabled]="commentsLoading() || !newCommentContent().trim()" class="px-6 py-2 bg-blue-accent text-white rounded-md font-semibold hover:bg-blue-accent/90 transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
              @if(commentsLoading()) {
                <span>Enviando...</span>
              } @else {
                Enviar Comentário
              }
            </button>
          </div>
        } @else {
          <div class="text-center p-6 bg-gray-900 border border-dashed border-gray-700 rounded-lg">
            <p class="text-gray-400">Você precisa estar logado para comentar.</p>
            <a routerLink="/login" class="mt-2 inline-block font-semibold text-blue-accent hover:underline">Fazer Login</a>
          </div>
        }
      </div>
    } @else {
      <div class="text-center py-16">
        <h1 class="text-3xl font-bold text-white">Template não encontrado</h1>
        <p class="mt-2 text-gray-400">O template que você está procurando não existe ou foi movido.</p>
        <a routerLink="/templates" class="mt-6 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-accent hover:bg-blue-accent/90">
            Voltar para a Galeria
        </a>
    </div>
    }
  }
</div>